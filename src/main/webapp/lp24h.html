<!DOCTYPE html>
<html data-ng-app="cuwyApp" data-ng-controller="lp24hCtrl">
<head>
	<meta charset="utf-8" />
	<title>{{siteMap.title}}</title>
	<link href="/css/bootstrap.css" rel="stylesheet"/>
	<link href="/css2/cuwy1-cpoe-hol1.css" rel="stylesheet"/>
</head>
<body>
	<a href="/home.html"><span class="glyphicon glyphicon-home"></span></a>
	/ <span class="h1">{{siteMap.name}}</span>
	<span class="navbar-right">
		<ul class="nav nav-pills" title="{{numberOfChange}} незбережених змін">
			<li ng-class="{'disabled': numberOfChange == 0}">
				<a ng-click="devPost()" href="#">
					<span class="glyphicon glyphicon-floppy-disk"></span>
					{{numberOfChange}}
					</a>
			</li>
		</ul>
	</span>
	<hr/>
	<div class="container">
	<div class="row">
	<div class="col-xs-12">
	<table>
	<caption>
	Name: 
	<span ng-context-menu="menuPrescribe" ng-show="!prescribes.editPrescribesName">
		{{prescribes.PRESCRIBE_NAME}}
	</span>
	<span ng-context-menu="menuPrescribe" ng-show="prescribes.editPrescribesName">
		<div class="row">
			<div class="col-xs-5">
				<input ng-model="prescribes.PRESCRIBE_NAME" type="text" class="form-control" />
			</div>
			<div class="col-xs-3">
			<!-- 
				<button title="Зберегти" type="button" ng-click="devPost()" class="btn btn-default">
			 -->
				<button title="Зберегти" type="button" ng-click="numberOfChange = numberOfChange +1" class="btn btn-default">
					<span class="glyphicon glyphicon-floppy-disk"></span>
				</button>
				<span title="Вийти" class="close navbar-right" data-ng-click="prescribes.editPrescribesName = false">
					<span class="glyphicon glyphicon-share-alt"></span>
				</span>
			</div>
		</div>
	</span>
	</caption>
		<thead>
			<tr>
				<th>N</th>
				<th data-ng-context-menu="menuTasksAll" >Призначеня</th>
				<th data-ng-repeat="dayHour in dayHours">
					|
					{{$index>9?'':'0'}}{{dayHour}}
				</th>
				<th>|</th>
			</tr>
		</thead>
		<tbody data-ng-repeat="taskInDay in tasksInDay" ng-init="taskInDayIndex = $index">
			<tr>
				<td>
					<u data-ng-show="prescribes.tasks.length == $index + 1">{{$index + 1}}</u>
					<span data-ng-show="prescribes.tasks.length != $index + 1">{{$index + 1 }}</span>
				</td>
				<td data-ng-click="taskInDay.isCollapsed = !taskInDay.isCollapsed"
				data-ng-context-menu="menuTask"
				title="{{taskInDay.isCollapsed}}"
				>
				{{prescribes.tasks[$index].DRUG_NAME == null ? "-":prescribes.tasks[$index].DRUG_NAME}}
				</td>
				<td data-ng-repeat="dayHour in dayHours"> . </td>
				<td>.</td>
			</tr>
			<tr data-ng-if="taskInDay.isCollapsed">
				<td />
				<td class="well" colspan="18">
					<span class="close navbar-right">
					<small>
					ліка | доза | час |
					<a data-ng-click="taskInDay.isCollapsed = false">
						<span class="glyphicon glyphicon-share-alt"></span>
					</a>
					</small>
					</span>
				<div class="row-fluid" title="{{taskInDay}}">
				ЛІКА
				{{taskInDayIndex + 1}}
				</div>

<form class="navbar-form navbar-left" role="search">
	<div class="form-group">
		<div class="input-group">
			<span class="input-group-addon">Пошук:</span>
			<input type="text" class="form-control" ng-model="seekDrug" auto-focus="" placeholder="Медикамент пошук / запис">
		</div>
	</div>
	<button type="submit" ng-click="saveNewDrug()" class="btn btn-default">
		<span class="glyphicon glyphicon-floppy-disk"></span>
	</button>
	<div>
	<div data-ng-repeat="drug in drug1sList | filter: seekDrug | limitTo : 12">
		<a ng-click="drugToTask(drug, taskInDay)">
		{{drug.DRUG_NAME}}
		{{$index}}
		</a>
	</div>
	</div>
</form>
				</td>
			</tr>
		</tbody>
	</table>
	</div>
	</div>
	</div>

	<hr/>
	<a href="protocols.html">Сторінка протоколів і схем призначень</a>

	<script src="/js/jquery-2.1.1.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/angular.min.js"></script>
	<script src="/js/angular-sanitize.min.js"></script>
	<script src="/js/ui-bootstrap-tpls-0.11.0.js"></script>
	<script src='/js/textAngular-sanitize.min.js'></script>
	<script src='/js/textAngular.min.js'></script>
	<script src="/db/drug1sList.json.js"></script>
	<script src="/js2/cuwy1.config.js"></script>
	<script src="/js2/cuwy1.directives.js"></script>
	<script type="text/javascript">
	cuwyApp.controller('lp24hCtrl', [ '$scope', '$http', function ($scope, $http) {
		console.log("lp24hCtrl");
		$scope.numberOfChange = 0;
		$scope.drug1sList = drug1sList;
		$scope.parameters = parameters;
		if(!$scope.parameters.id)
			$scope.parameters.id = 0;
		console.log($scope.parameters);

		$scope.siteMap = config.siteMap.siteMaps[2];
		var dayHours = [];
		for(var i=0;i<24;i++) dayHours.push(i);
		$scope.dayHours = dayHours;
		var tasksInDay = [];
		for(var ii=0;ii<12;ii++){
			tasksInDay.push({i:ii,isCollapsed:false});
		}
		$scope.tasksInDay = tasksInDay;
		
		$http({
			method : 'GET',
			url : '/read/prescribe_'+$scope.parameters.id
		}).success(function(data, status, headers, config) {
			console.log(data);
			$scope.prescribes = data;
			if(null == $scope.prescribes.tasks)
				$scope.prescribes.tasks = [];
		}).error(function(data, status, headers, config) {
		});

		$scope.drugToTask = function(drug, taskInDay){
			console.log("drugToTask");
			console.log(drug);
			console.log(taskInDay);
			var addNull = taskInDay.i - $scope.prescribes.tasks.length;
			if(addNull > 0){
				for (i = 0; i < addNull; i++) {
					$scope.prescribes.tasks.push(null);
				}
				$scope.prescribes.tasks.push(drug);
				$scope.numberOfChange++;
			}else if(null == $scope.prescribes.tasks[taskInDay.i]){
				$scope.prescribes.tasks[taskInDay.i] = drug;
				$scope.numberOfChange++;
			}else{
				console.log("rewrite drug? watch with times? ");
			}
			console.log($scope.prescribes.tasks);
		}

		$scope.devPost = function(){
			console.log("--------devPost-----------");
			$scope.prescribes.editPrescribesName = false;
			$http({
				method : 'POST',
				data : $scope.prescribes,
				url : "/save/prescribes"
			}).success(function(data, status, headers, config){
				console.log(data);
				$scope.prescribes = data;
			}).error(function(data, status, headers, config) {
				$scope.error = data;
			});
		}

		moveTo = function(arrayToSort, indexFrom, indexTo){
			var el = arrayToSort.splice(indexFrom, 1);
			arrayToSort.splice(indexTo, 0, el[0]);
		}

		moveUp = function(arrayToSort, index){
			moveTo(arrayToSort, index,index-1);
		}

		contextMenuPaste = function($itemScope){
			console.log('Paste');
			console.log($itemScope);
			$http({
				method : 'GET',
				url : '/session/paste'
			}).success(function(data, status, headers, config) {
				console.log(data);
				var drug = data;
				console.log($itemScope.taskInDay);
				$scope.drugToTask(drug, $itemScope.taskInDay);
			}).error(function(data, status, headers, config) {
			});
		}
		contextMenuCopy = function(copyObject){
			console.log("contextMenuCopy");
			console.log(copyObject);
			$http({
				method : 'POST',
				data : copyObject,
				url : "/session/copy"
			}).success(function(data, status, headers, config){
				console.log(data);
			}).error(function(data, status, headers, config) {
				$scope.error = data;
			});
		}

		$scope.menuPrescribe = [
			['<span class="glyphicon glyphicon-edit"></span> Корекція', function ($itemScope) {
				console.debug('Edit');
				console.log($itemScope);
				
				$itemScope.prescribes.editPrescribesName = !$itemScope.prescribes.editPrescribesName;
				console.log($itemScope.prescribes.editPrescribesName);
			}]
		];
		$scope.menuTasksAll = [
			['Copy', function ($itemScope) { contextMenuCopy($itemScope.prescribes); }],
			['Paste', function ($itemScope) { 
				$http({
					method : 'GET',
					url : '/session/paste'
				}).success(function(data, status, headers, config) {
					if($scope.prescribes.tasks.length == 0){
						$scope.prescribes.tasks = data.tasks;
						$scope.numberOfChange += $scope.prescribes.tasks.length;
					}
				}).error(function(data, status, headers, config) {
				});
			}]
		];
		$scope.menuTask = [
			['Copy', function ($itemScope) { 
				console.log('Copy');
				console.log($itemScope);
				console.log($itemScope.taskInDayIndex);
				var drug = $itemScope.prescribes.tasks[$itemScope.taskInDayIndex];
				console.log(drug);
				contextMenuCopy(drug); 
			}],
			['Paste', function ($itemScope) { contextMenuPaste($itemScope); }],
			null,
			['Додати строчку', function ($itemScope) {
				$itemScope.prescribes.tasks.splice($itemScope.$index, 0, null);
				$scope.numberOfChange++;
			}],
			['Видалити', function ($itemScope) {
				console.log('Delete');
				$itemScope.prescribes.tasks.splice($itemScope.$index, 1);
				$scope.numberOfChange++;
			}],
			null,
			['<span class="glyphicon glyphicon-arrow-up"></span> Догори', function ($itemScope) {
				console.log($itemScope.prescribes.tasks);
				var arrayToSort = $itemScope.prescribes.tasks;
				var index = $itemScope.$index;
				if(index > 0){
					moveUp(arrayToSort, index);
				}else{
					moveTo(arrayToSort, 0, arrayToSort.length-1);
				}
			}],
			['<span class="glyphicon glyphicon-arrow-down"></span> Донизу', function ($itemScope) {
				console.log('Down');
				console.log($itemScope.prescribes.tasks);
				console.log($itemScope);
				var index = $itemScope.$index + 1;
				var arrayToSort = $itemScope.prescribes.tasks;
				if(index < arrayToSort.length){
					moveUp(arrayToSort, index);
				}else{
					moveTo(arrayToSort, index-1,0);
				}
			}]
		];

	} ] );
	</script>
</body>
</html>
