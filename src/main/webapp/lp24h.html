<!DOCTYPE html>
<html data-ng-app="cuwyApp" data-ng-controller="lp24hCtrl">
<head>
	<meta charset="utf-8" />
	<title>{{siteMap.title}}</title>
	<link href="/css/bootstrap.css" rel="stylesheet"/>
	<link href="/css2/cuwy1-cpoe-hol1.css" rel="stylesheet"/>
</head>
<body>
	<a href="/home.html"><span class="glyphicon glyphicon-home"></span></a>
	/ <span class="h1">{{siteMap.name}}</span>
	<span class="navbar-right">
		<ul class="nav nav-pills" title="{{numberOfChange}} незбережених змін">
			<li ng-class="{'disabled': numberOfChange == 0}">
				<a ng-click="devPost()" href="#">
					<span class="glyphicon glyphicon-floppy-disk"></span>
					{{numberOfChange}}
					</a>
			</li>
		</ul>
	</span>
	<hr/>
	<div class="container">
	<div class="row">
	<div class="col-xs-12">
	<table>
	<caption>
	Name: 
	<span ng-context-menu="menuPrescribe" ng-show="!prescribes.editPrescribesName">
		{{prescribes.PRESCRIBE_NAME}}
	</span>
	<span ng-context-menu="menuPrescribe" ng-show="prescribes.editPrescribesName">
		<div class="row">
			<div class="col-xs-5">
				<input ng-model="prescribes.PRESCRIBE_NAME" type="text" class="form-control" />
			</div>
			<div class="col-xs-3">
			<!-- 
				<button title="Зберегти" type="button" ng-click="devPost()" class="btn btn-default">
			 -->
				<button title="Зберегти" type="button" ng-click="numberOfChange = numberOfChange +1" class="btn btn-default">
					<span class="glyphicon glyphicon-floppy-disk"></span>
				</button>
				<span title="Вийти" class="close navbar-right" data-ng-click="prescribes.editPrescribesName = false">
					<span class="glyphicon glyphicon-share-alt"></span>
				</span>
			</div>
		</div>
	</span>
	</caption>
		<thead>
			<tr>
				<th>N</th>
				<th data-ng-context-menu="menuTasksAll" >Призначеня</th>
				<th data-ng-repeat="dayHour in dayHours">
					|
					{{$index>9?'':'0'}}{{dayHour}}
				</th>
				<th>|</th>
			</tr>
		</thead>
		<!-- 
				data-ng-init="currentDrug = prescribes.tasks[$index]"
		 -->
		<tbody data-ng-repeat="taskInDay in tasksInDay"
				ng-init="taskInDayIndex = $index"
		>
			<tr>
				<td>
					<u data-ng-show="prescribes.tasks.length == $index + 1">{{$index + 1}}</u>
					<span data-ng-show="prescribes.tasks.length != $index + 1">{{$index + 1 }}</span>
				</td>
				<td data-ng-click="openPrescribeDrugDialog(taskInDay, $index)"
				data-ng-context-menu="menuTask"
				title="{{taskInDay.isCollapsed}}"
				>
				{{prescribes.tasks[$index].DRUG_NAME == null ? "-":prescribes.tasks[$index].DRUG_NAME}}
					<span>
						{{prescribes.tasks[$index].dose.DOSE_NUMBER}}
						{{prescribes.tasks[$index].dose.DOSE_UNIT}}
					</span>
				</td>
				<td data-ng-repeat="dayHour in dayHours"
				 data-ng-click="useHour(taskInDay, taskInDayIndex, $index)"
				> . 
					<span 
					data-ng-show="'-' == prescribes.tasks[taskInDayIndex].times.hours[$index]"
					class="glyphicon glyphicon-minus"></span>
				</td>
				<td>.</td>
			</tr>
			<tr data-ng-if="taskInDay.isCollapsed">
				<td />
				<td class="well" colspan="18">
					<span class="close navbar-right">
					<small>
					<span data-ng-click="taskInDay.dialogTab='drug'">
						<span data-ng-show="taskInDay.dialogTab != 'drug'">ліка</span>
						<u data-ng-show="taskInDay.dialogTab == 'drug'">ліка</u>
					</span>
					|
					<span data-ng-click="taskInDay.dialogTab='dose'">
						<span data-ng-show="taskInDay.dialogTab != 'dose'">доза</span>
						<u data-ng-show="taskInDay.dialogTab == 'dose'">доза</u>
					</span>
					|
					<span data-ng-click="taskInDay.dialogTab='times'">
						<span data-ng-show="taskInDay.dialogTab != 'times'">час</span>
						<u data-ng-show="taskInDay.dialogTab == 'times'">час</u>
					</span>
					|
					<a data-ng-click="taskInDay.isCollapsed = false">
						<span class="glyphicon glyphicon-share-alt"></span>
					</a>
					</small>
					</span>
			<div class="row-fluid" title="{{taskInDay}}">
			ЛІКА
			{{$index + 1}}
			{{prescribes.tasks[$index].DRUG_NAME}}
			</div>
			<div data-ng-show="taskInDay.dialogTab=='drug'">
				<form class="navbar-form navbar-left" role="search">
					<div class="form-group">
						<div class="input-group">
							<span class="input-group-addon">Пошук:</span>
							<input type="text" class="form-control" data-ng-model="seekDrug" auto-focus="" placeholder="Медикамент пошук / запис">
						</div>
					</div>
					<button  data-ng-click="saveNewDrug(seekDrug)" class="btn btn-default">
						<span class="glyphicon glyphicon-floppy-disk"></span>
					</button>
					<div>
					<div data-ng-repeat="drug in drug1sList | filter: seekDrug | limitTo : 12">
						<a ng-click="drugToTask(drug, taskInDay)">
						{{drug.DRUG_NAME}}
						{{$index}}
						</a>
					</div>
					</div>
				</form>
			</div>
			<div data-ng-show="taskInDay.dialogTab=='dose'">
				<span data-ng-repeat="dose in drugDocument.doses" data-ng-click="addDose(dose)">
					{{dose.DOSE_NUMBER}}
					{{dose.DOSE_UNIT}}
					<!-- 
					{{dose}}
					 -->
					 |
				</span>
				<hr/>
			</div>
				<span class="close navbar-right">
					<small>
					Додаток:
					<a href="/drug.html?id={{prescribes.tasks[$index].DRUG_ID}}">
					{{prescribes.tasks[$index].DRUG_NAME}}
					</a>
					</small>
				</span>
				</td>
			</tr>
		</tbody>
	</table>
	</div>
	</div>
	</div>

	<hr/>
	<a href="protocols.html">Сторінка протоколів і схем призначень</a>

	<script src="/js/jquery-2.1.1.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/angular.min.js"></script>
	<script src="/js/angular-sanitize.min.js"></script>
	<script src="/js/ui-bootstrap-tpls-0.11.0.js"></script>
	<script src='/js/textAngular-sanitize.min.js'></script>
	<script src='/js/textAngular.min.js'></script>
	<script src="/db/drug1sList.json.js"></script>
	<script src="/js2/cuwy1.config.js"></script>
	<script src="/js2/cuwy1.directives.js"></script>
	<script type="text/javascript">
	cuwyApp.controller('lp24hCtrl', [ '$scope', '$http', function ($scope, $http) {
		console.log("lp24hCtrl");
		$scope.numberOfChange = 0;
		$scope.drug1sList = drug1sList;
		$scope.parameters = parameters;
		if(!$scope.parameters.id)
			$scope.parameters.id = 0;
		console.log($scope.parameters);

		getDayHours = function(){
			var dayHours = [];
			for(var i=0;i<24;i++) dayHours.push(i);
			return dayHours;
		}

		getDayHoursEmpty = function(){
			var dayHours = [];
			for(var i=0;i<24;i++) dayHours.push(null);
			return dayHours;
		}

		$scope.siteMap = config.siteMap.siteMaps[2];
		$scope.dayHours = getDayHours();
		var tasksInDay = [];
		for(var ii=0;ii<12;ii++){
			tasksInDay.push({i:ii,isCollapsed:false});
		}
		$scope.tasksInDay = tasksInDay;

		$http({
			method : 'GET',
			url : '/read/prescribe_'+$scope.parameters.id
		}).success(function(data, status, headers, config) {
			console.log(data);
			$scope.prescribes = data;
			if(null == $scope.prescribes.tasks)
				$scope.prescribes.tasks = [];
		}).error(function(data, status, headers, config) {
		});

		$scope.useHour = function(taskInDay, taskInDayIndex, $index){
			if(taskInDay.isCollapsed){
				var hour = $index;
				console.log(taskInDay);
				console.log(taskInDayIndex);
				console.log($index);
				var editedDrug = $scope.prescribes.tasks[taskInDay.i];
				if(!editedDrug.times){
					editedDrug.times = {};
					editedDrug.times.hours = getDayHoursEmpty();
				}
				if(!editedDrug.times.hours[$index]){
					editedDrug.times.hours[$index] = "-";
				}else{
					editedDrug.times.hours[$index] = null;
				}
				console.log(editedDrug);
				$scope.numberOfChange++;
			}
		}

		$scope.openPrescribeDrugDialog = function(taskInDay, $index){
			console.log("openPrescribeDrugDialog");
			var oldCollapsed = taskInDay.isCollapsed;
			$($scope.tasksInDay).each(function () {
				this.isCollapsed = false;
			} );
			taskInDay.isCollapsed = !oldCollapsed;
			$scope.editedPrescribeDrug =  $scope.prescribes.tasks[$index];
			console.log($scope.editedPrescribeDrug);
			if(null == $scope.editedPrescribeDrug){
				taskInDay.dialogTab = "drug";
			}else{
				taskInDay.dialogTab = "dose";
			}

			$http({
				method : 'GET',
				url : '/read/drug_'+$scope.editedPrescribeDrug.DRUG_ID
			}).success(function(data, status, headers, config) {
				console.log(data);
				$scope.drugDocument = data;
			}).error(function(data, status, headers, config) {
			});
			
		}
		$scope.addDose = function(doseToAdd){
			console.log(doseToAdd);
			console.log($scope.editedPrescribeDrug);
			$scope.editedPrescribeDrug.dose = doseToAdd;
			$scope.numberOfChange++;
		}
		$scope.drugToTask = function(drug, taskInDay){
			console.log("drugToTask");
			console.log(drug);
			console.log(taskInDay);
			var addNull = taskInDay.i - $scope.prescribes.tasks.length;
			if(addNull > 0){
				for (i = 0; i < addNull; i++) {
					$scope.prescribes.tasks.push(null);
				}
				$scope.prescribes.tasks.push(drug);
				$scope.numberOfChange++;
			}else if(null == $scope.prescribes.tasks[taskInDay.i]){
				$scope.prescribes.tasks[taskInDay.i] = drug;
				$scope.numberOfChange++;
			}else{
				console.log("rewrite drug? watch with times? ");
				$scope.prescribes.tasks[taskInDay.i] = drug;
				$scope.numberOfChange++;
			}
			console.log($scope.prescribes.tasks);
		}

		$scope.devPost = function(){
			console.log("--------devPost-----------");
			$scope.prescribes.editPrescribesName = false;
			$http({
				method : 'POST',
				data : $scope.prescribes,
				url : "/save/prescribes"
			}).success(function(data, status, headers, config){
				console.log(data);
				$scope.prescribes = data;
			}).error(function(data, status, headers, config) {
				$scope.error = data;
			});
		}

		$scope.saveNewDrug = function(seekDrug){
			console.log("saveNewDrug");
			console.log(seekDrug);
			$http({
				method : 'POST',
				data : {"DRUG_NAME":seekDrug},
				url : '/saveNewDrug'
			}).success(function(data, status, headers, config){
				$scope.drug1sList = data;
				console.log(data);
			}).error(function(data, status, headers, config) {
				$scope.error = data;
			});
		}


		moveTo = function(arrayToSort, indexFrom, indexTo){
			var el = arrayToSort.splice(indexFrom, 1);
			arrayToSort.splice(indexTo, 0, el[0]);
		}

		moveUp = function(arrayToSort, index){
			moveTo(arrayToSort, index,index-1);
		}

		contextMenuPaste = function($itemScope){
			console.log('Paste');
			console.log($itemScope);
			$http({
				method : 'GET',
				url : '/session/paste'
			}).success(function(data, status, headers, config) {
				console.log(data);
				var drug = data;
				console.log($itemScope.taskInDay);
				$scope.drugToTask(drug, $itemScope.taskInDay);
			}).error(function(data, status, headers, config) {
			});
		}
		contextMenuCopy = function(copyObject){
			console.log("contextMenuCopy");
			console.log(copyObject);
			$http({
				method : 'POST',
				data : copyObject,
				url : "/session/copy"
			}).success(function(data, status, headers, config){
				console.log(data);
			}).error(function(data, status, headers, config) {
				$scope.error = data;
			});
		}

		$scope.menuPrescribe = [
			['<span class="glyphicon glyphicon-edit"></span> Корекція', function ($itemScope) {
				console.debug('Edit');
				console.log($itemScope);
				
				$itemScope.prescribes.editPrescribesName = !$itemScope.prescribes.editPrescribesName;
				console.log($itemScope.prescribes.editPrescribesName);
			}]
		];
		$scope.menuTasksAll = [
			['Copy', function ($itemScope) { contextMenuCopy($itemScope.prescribes); }],
			['Paste', function ($itemScope) { 
				$http({
					method : 'GET',
					url : '/session/paste'
				}).success(function(data, status, headers, config) {
					if($scope.prescribes.tasks.length == 0){
						$scope.prescribes.tasks = data.tasks;
						$scope.numberOfChange += $scope.prescribes.tasks.length;
					}
				}).error(function(data, status, headers, config) {
				});
			}]
		];
		$scope.menuTask = [
			['Copy', function ($itemScope) { 
				console.log('Copy');
				console.log($itemScope);
				console.log($itemScope.$index);
				var drug = $itemScope.prescribes.tasks[$itemScope.$index];
				console.log(drug);
				contextMenuCopy(drug); 
			}],
			['Paste', function ($itemScope) { contextMenuPaste($itemScope); }],
			null,
			['Додати строчку', function ($itemScope) {
				$itemScope.prescribes.tasks.splice($itemScope.$index, 0, null);
				$scope.numberOfChange++;
			}],
			['Видалити', function ($itemScope) {
				console.log('Delete');
				$itemScope.prescribes.tasks.splice($itemScope.$index, 1);
				$scope.numberOfChange++;
			}],
			null,
			['<span class="glyphicon glyphicon-arrow-up"></span> Догори', function ($itemScope) {
				console.log($itemScope.prescribes.tasks);
				var arrayToSort = $itemScope.prescribes.tasks;
				var index = $itemScope.$index;
				if(index > 0){
					moveUp(arrayToSort, index);
				}else{
					moveTo(arrayToSort, 0, arrayToSort.length-1);
				}
			}],
			['<span class="glyphicon glyphicon-arrow-down"></span> Донизу', function ($itemScope) {
				console.log('Down');
				console.log($itemScope.prescribes.tasks);
				console.log($itemScope);
				var index = $itemScope.$index + 1;
				var arrayToSort = $itemScope.prescribes.tasks;
				if(index < arrayToSort.length){
					moveUp(arrayToSort, index);
				}else{
					moveTo(arrayToSort, index-1,0);
				}
			}]
		];

	} ] );
	</script>
</body>
</html>
